# Git worktree management function
# Usage: wt <go|ls|rm|clean> [name]

local subcmd="$1"
shift

case "$subcmd" in
  go)
    local name="$1"
    if [[ -z "$name" ]]; then
      echo "Usage: wt go <name>" >&2
      return 1
    fi

    local repo_root
    repo_root=$(git rev-parse --show-toplevel 2>/dev/null)
    if [[ $? -ne 0 ]]; then
      echo "Error: Not in a git repository" >&2
      return 1
    fi

    local repo_name
    repo_name=$(basename "$repo_root")

    local branch_prefix
    branch_prefix=$(git prefix-branch 2>/dev/null | tr -d '\n')
    if [[ $? -ne 0 ]]; then
      branch_prefix=""
    fi

    local branch_name="${branch_prefix}${name}"
    local worktree_path="${repo_root}/../${repo_name}-${name}"

    # Check if branch exists
    if git rev-parse --verify "$branch_name" &>/dev/null; then
      echo "Checking out existing branch: $branch_name"
      git worktree add "$worktree_path" "$branch_name"
    else
      echo "Creating new branch: $branch_name"
      git worktree add -b "$branch_name" "$worktree_path"
    fi

    if [[ $? -eq 0 ]]; then
      echo "Worktree created at: $worktree_path"
      cd "$worktree_path"
    fi
    ;;

  ls)
    git worktree list
    ;;

  rm)
    local name="$1"
    if [[ -z "$name" ]]; then
      echo "Usage: wt rm <name>" >&2
      return 1
    fi

    local repo_root
    repo_root=$(git rev-parse --show-toplevel 2>/dev/null)
    if [[ $? -ne 0 ]]; then
      echo "Error: Not in a git repository" >&2
      return 1
    fi

    local repo_name
    repo_name=$(basename "$repo_root")
    local worktree_path
    worktree_path=$(builtin cd "${repo_root}/.." && pwd)/${repo_name}-${name}

    # Get the branch name from the worktree
    local branch_name
    branch_name=$(git worktree list --porcelain | grep -A 2 "^worktree ${worktree_path}\$" | grep "^branch " | sed 's/^branch refs\/heads\///')

    if [[ -z "$branch_name" ]]; then
      echo "Error: Worktree not found at $worktree_path" >&2
      return 1
    fi

    echo "Removing worktree: $worktree_path"
    git worktree remove "$worktree_path"

    if [[ $? -eq 0 ]]; then
      echo "Deleting branch: $branch_name"
      git branch -D "$branch_name"
    fi
    ;;

  clean)
    local repo_root
    repo_root=$(git rev-parse --show-toplevel 2>/dev/null)
    if [[ $? -ne 0 ]]; then
      echo "Error: Not in a git repository" >&2
      return 1
    fi

    local repo_name
    repo_name=$(basename "$repo_root")
    local main_branch
    main_branch=$(git rev-parse --abbrev-ref origin/HEAD 2>/dev/null | sed 's/origin\///')
    if [[ -z "$main_branch" ]]; then
      main_branch="main"
    fi

    # Collect clean worktrees
    local -a clean_worktree_names
    local current_worktree=""
    local current_branch=""

    while IFS= read -r line; do
      if [[ "$line" =~ ^worktree ]]; then
        current_worktree="${line#worktree }"
      elif [[ "$line" =~ ^branch ]]; then
        current_branch="${line#branch refs/heads/}"
      elif [[ -z "$line" && -n "$current_worktree" ]]; then
        # End of worktree entry - check if it's clean and not main
        if [[ "$current_branch" != "$main_branch" && "$current_worktree" != "$repo_root" ]]; then
          # Check for uncommitted changes
          local status_output
          status_output=$(builtin cd "$current_worktree" && git status --porcelain 2>/dev/null)
          if [[ -z "$status_output" ]]; then
            # Extract name from path
            local wt_name="${current_worktree##*/}"
            wt_name="${wt_name#${repo_name}-}"
            clean_worktree_names+=("$wt_name (branch: $current_branch)")
          fi
        fi
        current_worktree=""
        current_branch=""
      fi
    done < <(git worktree list --porcelain)

    if [[ ${#clean_worktree_names[@]} -eq 0 ]]; then
      echo "No clean worktrees found to remove."
      return 0
    fi

    echo "Clean worktrees (no uncommitted changes):"
    select choice in "${clean_worktree_names[@]}" "Cancel"; do
      if [[ "$choice" == "Cancel" ]]; then
        echo "Cancelled."
        return 0
      elif [[ -n "$choice" ]]; then
        # Extract name before " (branch:"
        local selected_name="${choice%% \(branch:*}"
        echo "Removing worktree: $selected_name"
        wt rm "$selected_name"
        break
      fi
    done
    ;;

  *)
    echo "Usage: wt <go|ls|rm|clean> [name]" >&2
    echo "" >&2
    echo "Commands:" >&2
    echo "  go <name>   Create or checkout a worktree" >&2
    echo "  ls          List all worktrees" >&2
    echo "  rm <name>   Remove a worktree and its branch" >&2
    echo "  clean       Interactively remove clean worktrees" >&2
    return 1
    ;;
esac
